<!DOCTYPE html>
<html lang="zh">
<head>
  <meta charset="utf-8" />
  <title>AI 聊天室</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    body { font-family: system-ui, -apple-system, "Segoe UI", Roboto, "Noto Sans CJK TC", "PingFang TC", "Microsoft JhengHei", sans-serif; margin:0; background:#f3f4f6; }
    .wrap { max-width: 980px; margin: 20px auto; display:flex; gap:16px; padding: 0 12px; }
    .panel { background:white; border-radius:12px; box-shadow:0 6px 20px rgba(0,0,0,0.06); padding:12px; flex:1; }
    #messages { height: 70vh; overflow-y:auto; padding:10px; border-radius:8px; border:1px solid #eef2f7; }
    .msg { padding:8px; margin-bottom:8px; border-radius:8px; }
    .msg.user { background:#eef6ff; text-align:left; }
    .msg.ai { background:#fff7ed; text-align:left; }
    .msg.system { background:#f3f4f5; color:#6b7280; font-size:13px; }
    #inputRow { display:flex; gap:8px; margin-top:10px; }
    input[type="text"] { flex:1; padding:10px; border-radius:8px; border:1px solid #e5e7eb; }
    button { padding:10px 12px; border-radius:8px; border:none; background:#0366d6; color:white; font-weight:600; }
    .side { width:240px; min-width:200px; }
    .meta { font-size:13px; color:#374151; margin-bottom:8px; }
  </style>
</head>
<body>
  <div class="wrap">
    <div class="panel">
      <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px">
        <div>
          <strong id="roomTitle">房間</strong>
          <div id="me" style="font-size:13px;color:#6b7280"></div>
        </div>
        <div style="font-size:12px;color:#9ca3af">AI: GPT 模型</div>
      </div>

      <div id="messages"></div>

      <div id="inputRow">
        <input id="msgInput" placeholder="輸入訊息，或輸入 /角色 老師 來設定AI扮演" />
        <button id="sendBtn">送出</button>
      </div>
    </div>

    <div class="panel side">
      <div class="meta">房間資訊</div>
      <div>房間：<span id="roomName"></span></div>
      <div>暱稱：<span id="userName"></span></div>
      <hr style="margin:8px 0" />
      <div class="meta">指令</div>
      <div><code>/角色 角色名</code> — 讓 AI 扮演指定角色（全房間生效）</div>
      <div style="margin-top:8px;color:#6b7280;font-size:13px">訊息會同步保存到資料庫。</div>
    </div>
  </div>

  <script src="/socket.io/socket.io.js"></script>
  <script>
    const socket = io();
    const params = new URLSearchParams(location.search);
    const user = params.get("user") || "訪客";
    const room = params.get("room") || "一般";

    document.getElementById("roomTitle").textContent = "房間：" + room;
    document.getElementById("roomName").textContent = room;
    document.getElementById("userName").textContent = user;
    document.getElementById("me").textContent = "你：" + user;

    const messagesEl = document.getElementById("messages");
    const input = document.getElementById("msgInput");
    const sendBtn = document.getElementById("sendBtn");

    function appendMessage(doc) {
      const d = document.createElement("div");
      d.className = "msg " + (doc.role || "user");
      const time = new Date(doc.timestamp).toLocaleString();
      d.innerHTML = `<div style="font-size:13px;color:#374151"><strong>${doc.user}</strong> <span style="font-size:12px;color:#6b7280"> ${time}</span></div>
                     <div style="margin-top:6px;white-space:pre-wrap">${doc.text}</div>`;
      messagesEl.appendChild(d);
      messagesEl.scrollTop = messagesEl.scrollHeight;
    }

    // 連線並 join
    socket.emit("join", { room, user });

    // 歷史
    socket.on("history", (docs) => {
      docs.forEach(appendMessage);
    });

    socket.on("system", (msg) => {
      appendMessage({ user: "系統", text: msg.text, role: "system", timestamp: new Date() });
    });

    socket.on("chat message", (msg) => {
      appendMessage(msg);
    });

    sendBtn.addEventListener("click", sendMessage);
    input.addEventListener("keypress", (e) => {
      if (e.key === "Enter") sendMessage();
    });

    function sendMessage() {
      const text = input.value.trim();
      if (!text) return;
      socket.emit("chat message", { room, user, text });
      input.value = "";
    }
  </script>
</body>
</html>
